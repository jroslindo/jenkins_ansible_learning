---
- name: Configure Server
  hosts: server
  tasks:
    - name: Clone the repo
      git:
        repo: https://github.com/jroslindo/jenkins_ansible_learning
        dest: /my_application
      become: yes

    - name: Install packages using poetry
      command: $HOME/.local/bin/poetry install --no-root
      args:
        chdir: /my_application/server
      become: yes

    - name: stop previous application
      command: pkill -f  /root/.cache/pypoetry/virtualenvs/cap-test
      become: yes
      ignore_errors: yes

    - name: Start my application in port 3000
      become: yes
      args:
        chdir: /my_application/server
      command: nohup $HOME/.local/bin/poetry run python3 /my_application/server/__main__.py > /dev/null 2>&1